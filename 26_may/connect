from pywinauto import Application, Desktop
import time

_connected_window = None
_window_title = None
_terminal_canvas = None
_char_w, _char_h = 8, 16

def connect_presentation_space(final_title_hint="256"):
    global _connected_window, _window_title, _terminal_canvas, _char_w, _char_h

    try:
        app = Application(backend="uia").connect(path="acslaunch_win_64.exe")

        for win in app.windows():
            if "ConsoleWindowClass" in win.element_info.class_name or "5250 Display" in win.window_text():
                win.set_focus()
                time.sleep(0.5)
                dlg = win
                break
        else:
            print("[ERROR] No matching window found")
            return False

        candidates = dlg.descendants()
        for c in candidates:
            if str(c.window_text()).strip() == final_title_hint:
                _terminal_canvas = c
                break

        if not _terminal_canvas:
            print("[WARNING] Terminal canvas not found.")
            return False

        rect = _terminal_canvas.element_info.rectangle
        _char_w = (rect.right - rect.left) / 80
        _char_h = (rect.bottom - rect.top) / 24

        _connected_window = dlg
        _window_title = dlg.window_text()

        print(f"[INFO] Connected to: {_window_title}")
        print(f"[INFO] Terminal Rect: {rect}")
        print(f"[INFO] Char Width: {_char_w:.2f}, Char Height: {_char_h:.2f}")
        return True

    except Exception as e:
        print("[ERROR] Connection Failed:", e)
        return False
